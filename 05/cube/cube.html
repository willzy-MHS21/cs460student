<html>
    <head>
        <style>
            html, body { 
                background-color:#000;
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden !important;  
            }
        </style>
    
        <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

        <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@latest/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
            }
        }
        </script>

        <script type="module">

            import * as THREE from 'three';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';      
            import { VRButton } from 'three/addons/webxr/VRButton.js';

            var scene, camera, renderer, controls, cube;

            window.onload = function() {
                window.THREE = THREE;  // make it global for the console

                // Create the scene
                scene = new THREE.Scene();

                // Set up the camera
                var fov = 75;
                var ratio = window.innerWidth / window.innerHeight;
                var zNear = 1;
                var zFar = 10000;
                camera = new THREE.PerspectiveCamera(fov, ratio, zNear, zFar);
                camera.position.set(0, 0, 100);
                
                // Set up the renderer and add the canvas
                renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setSize(window.innerWidth, window.innerHeight);

                renderer.xr.enabled = true;
                renderer.xr.setReferenceSpaceType('local-floor');

                document.body.appendChild(renderer.domElement);
                document.body.appendChild(VRButton.createButton(renderer));

                renderer.domElement.onclick = function(e) {
                    var pixel_coords = new THREE.Vector2(e.clientX, e.clientY);
                    var vp_coords = new THREE.Vector2(
                        (pixel_coords.x / window.innerWidth) * 2 - 1,
                        -(pixel_coords.y / window.innerHeight) * 2 + 1
                    );
                    
                    var vp_coords_znear = new THREE.Vector3(vp_coords.x, vp_coords.y, 0);

                    var raycaster = new THREE.Raycaster();
                    raycaster.setFromCamera(vp_coords_znear, camera);

                    var intersects = raycaster.intersectObject(invisible_plane);

                    cube.position.set(intersects[0].point.x, intersects[0].point.y, intersects[0].point.z);
                }

                // Set up lights
                var ambientLight = new THREE.AmbientLight();
                scene.add(ambientLight);

                var directionalLight = new THREE.DirectionalLight(0xffffff, 5.0);
                directionalLight.position.set(10, 100, 10);
                scene.add(directionalLight);

                // Add cubes
                var geometry = new THREE.BoxGeometry(20, 20, 20);
                var material = new THREE.MeshLambertMaterial({color: 0xffffff, wireframe: false}); 
                cube = new THREE.Mesh(geometry, material);
                scene.add(cube);

                // Add invisible plane for raycasting
                geometry = new THREE.PlaneGeometry(1000, 1000);
                material = new THREE.MeshBasicMaterial({visible: false});
                var invisible_plane = new THREE.Mesh(geometry, material);
                scene.add(invisible_plane);

                // Set up iterations
                controls = new OrbitControls(camera, renderer.domElement);

                // call animation/rendering loop
                // animate();
                renderer.setAnimationLoop(animate);
            };

            function animate(time) {
                // requestAnimationFrame(animate);

                cube.rotation.x += 0.03;
                cube.rotation.y += 0.03;

                // ... update renderer + controls
                controls.update();
                renderer.render(scene, camera);
            };
        </script>
    </head>

    <body>

    </body>
</html>
